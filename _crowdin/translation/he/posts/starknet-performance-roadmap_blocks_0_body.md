### TL;DR

* אוסף תוקף אינו מוגבל בתפוקה באותו אופן כמו L1s. זה מוביל ל-TPS פוטנציאלי גבוה בהרבה על אוסף תוקף L2.
* מפת הדרכים של ביצועי StarkNet מתייחסת למרכיב מרכזי במערכת: הרצף.
* אנו מציגים כאן את מפת הדרכים לשיפורי ביצועים:\
  — מקבילת רצפים\
  — יישום חלודה חדש עבור ה-Cairo VM\
  — יישום מחדש של רצף בחלודה\
* מוכיחים, כשהם נבחנים בקרב כפי שהם, הם לא צוואר הבקבוק והם יכולים להתמודד עם הרבה יותר ממה שהם עושים עכשיו!

### הקדמה

StarkNet הושקה ב-Mainnet לפני כמעט שנה. התחלנו לבנות את StarkNet על ידי התמקדות בפונקציונליות. כעת, אנו מעבירים את המיקוד לשיפור הביצועים באמצעות סדרה של שלבים שיעזרו לשפר את חווית StarkNet.

בפוסט זה, אנו מסבירים מדוע יש מגוון רחב של אופטימיזציות שישימות רק באוסף תוקף, ונשתף את התוכנית שלנו ליישם את השלבים הללו ב-StarkNet. חלק מהצעדים הללו כבר מיושמים ב-StarkNet Alpha 0.10.2, ששוחרר ב-Testnet ב-16 בנובמבר ואתמול ב-Mainnet. אבל לפני שנדון בפתרונות, בואו נסקור את המגבלות והסיבות להן.

### מגבלות חסימה: אוסף תוקף לעומת L1

גישה פוטנציאלית להגדלת מדרגיות הבלוקצ'יין והגדלת ה-TPS תהיה הסרת מגבלות הבלוק (במונחים של גז/גודל) תוך שמירה על זמן החסימה קבוע. זה ידרוש יותר מאמץ ממפיקי הבלוקים (מאמתים ב-L1, רצפים ב-L2) ולכן דורש יישום יעיל יותר של רכיבים אלה. לשם כך, אנו מעבירים כעת את המיקוד לאופטימיזציות של רצפי StarkNet, אותן אנו מתארים ביתר פירוט בסעיפים הבאים.

מתעוררת כאן שאלה טבעית. מדוע אופטימיזציות של רצף מוגבלות לאוסף תוקף, כלומר, מדוע איננו יכולים ליישם את אותם שיפורים ב-L1 ולהימנע לחלוטין מהמורכבות של אוסף תוקף? בסעיף הבא, אנו טוענים שיש הבדל מהותי בין השניים, המאפשר מגוון רחב של אופטימיזציות ב-L2 שאינן ישימות ל-L1.

### מדוע תפוקת L1 מוגבלת?

למרבה הצער, הסרת מגבלות החסימה ב-L1 סובלת ממלכוד גדול. על ידי הגדלת קצב הצמיחה של השרשרת, אנו גם מגבירים את הדרישות מצמתים מלאים, שמנסים לעמוד בקצב העדכני ביותר. מכיוון שצמתים מלאים L1 חייבים לבצע מחדש את כל ההיסטוריה, גידול גבוה בגודל הבלוק (במונחים של גז) מעמיס עליהם עומס משמעותי, שוב מוביל לנשירת מכונות חלשות יותר מהמערכת ומשאירות את היכולת להפעיל צמתים מלאים. רק לגופים גדולים מספיק. כתוצאה מכך, משתמשים לא יוכלו לאמת את המצב בעצמם ולהשתתף ברשת ללא אמון.

זה משאיר אותנו עם ההבנה שיש להגביל את תפוקת L1, על מנת לשמור על מערכת מבוזרת ומאובטחת באמת.

### מדוע אותם חסמים אינם משפיעים על אוסף תוקף?

**רק כאשר בוחנים את נקודת המבט המלאה של הצומת אנו רואים את העוצמה האמיתית שמציעה אוסף תוקף.**צומת מלא L1 צריך לבצע מחדש את כל ההיסטוריה כדי להבטיח את נכונות המצב הנוכחי. צמתים של StarkNet צריכים רק לאמת הוכחות STARK, ואימות זה דורש כמות נמוכה יותר באופן אקספוננציאלי של משאבי חישוב. בפרט, סנכרון מאפס אינו חייב לכלול ביצוע; צומת עשוי לקבל dump של המצב הנוכחי מעמיתיו ולאמת רק באמצעות הוכחה STARK שמצב זה חוקי. זה מאפשר לנו להגדיל את התפוקה של הרשת מבלי להגדיל את הדרישות מהצומת המלא.

לכן אנו מסיקים שהרצף L2 כפוף לספקטרום שלם של אופטימיזציות שאינן אפשריות ב-L1.

### מפת הדרכים של ביצועים קדימה

בסעיפים הבאים, נדון באילו מהם מתוכננים כעת עבור הרצף של StarkNet.

### מקבילית רצף

הצעד הראשון במפת הדרכים שלנו היה הצגת הקבלה לביצוע העסקה. זה הוצג ב-StarkNet alpha 0.10.2, ששוחרר אתמול ב-Mainnet. עכשיו אנחנו צוללים למה זה הקבלה (זהו קטע חצי טכני, כדי להמשיך במפת הדרכים, קפוץ לסעיף הבא).

אז מה המשמעות של "מקבילות עסקה"? באופן נאיבי, ביצוע בלוק של עסקאות במקביל הוא בלתי אפשרי מכיוון שעסקאות שונות עשויות להיות תלויות. זה מומחש בדוגמה הבאה. שקול חסימה עם שלוש עסקאות מאותו משתמש:

* עסקה א': החלפת USDC עבור ETH
* עסקה ב': שלם ETH עבור NFT
* עסקה C: החלפת USDT עבור BTC

ברור ש-Tx A חייב להתרחש לפני Tx B, אבל Tx C אינו תלוי לחלוטין בשניהם וניתן לבצע אותו במקביל. אם כל עסקה דורשת שנייה אחת לביצוע, אזי ניתן להפחית את זמן ייצור הבלוק מ-3 שניות ל-2 שניות על ידי הכנסת הקבלה.

עיקר הבעיה הוא שאיננו יודעים מראש את התלות בעסקאות. בפועל, רק כאשר אנו מבצעים עסקה B מהדוגמה שלנו אנו רואים שהיא מסתמכת על שינויים שבוצעו על ידי עסקה A. באופן פורמלי יותר, התלות נובעת מכך שעסקה B קוראת מתאי אחסון שעסקה א' כתבה אליהם. אנו יכולים לחשוב על העסקאות כעל יוצרות גרף תלות, שבו יש קצה מעסקה A לעסקה B אם A כותבת לתא אחסון שנקרא על ידי B, ולכן יש לבצע אותה לפני B. האיור הבא מציג דוגמה לגרף תלות כזה:

![](https://miro.medium.com/max/641/0*I-qGgxdJJmqmgZWM)

בדוגמה לעיל, כל עמודה יכולה להתבצע במקביל, וזהו הסידור האופטימלי (בעוד שבאופן נאיבי, היינו מבצעים טרנזקציות 1–9 ברצף).

כדי להתגבר על העובדה שגרף התלות אינו ידוע מראש, אנו מציגים את***מקבילה אופטימית***, ברוח[BLOCK-STM](https://malkhi.com/posts/2022/04/block-stm/)שפותחה על ידי Aptos Labs, לרצף StarkNet. לפי פרדיגמה זו, אנו מנסים באופטימיות להפעיל עסקאות במקביל ולבצע מחדש לאחר מציאת התנגשות. לדוגמה, אנו עשויים לבצע טרנזקציות 1-4 מאיור 1 במקביל, רק כדי לגלות לאחר מכן ש-Tx4 תלוי ב-Tx1. לפיכך, הביצוע שלו היה חסר תועלת (הרצנו אותו ביחס לאותו מצב מולו הרצנו את Tx1, בעוד שהיינו צריכים להפעיל אותו נגד המדינה הנובעת מהחלת Tx1). במקרה כזה, נבצע מחדש את Tx4.

שימו לב שאנו יכולים להוסיף אופטימיזציות רבות על הקבלה אופטימית. לדוגמה, במקום לחכות בתמימות לסיום כל ביצוע, אנו יכולים לבטל ביצוע ברגע שנמצא תלות שמבטלת אותה.

דוגמה נוספת היא אופטימיזציה של הבחירה אילו עסקאות לבצע מחדש. נניח שבלוק שמורכב מכל העסקאות מאיור 1 מוזן לרצף עם חמש ליבות מעבד. ראשית, אנו מנסים לבצע טרנזקציות 1-5 במקביל. אם סדר ההשלמה היה Tx2, Tx3, Tx4, Tx1 ולבסוף Tx5, אז נמצא את התלות Tx1→Tx4 רק לאחר ש-Tx4 כבר בוצע - מה שמצביע על כך שיש לבצע אותה מחדש. בתמימות, ייתכן שנרצה לבצע מחדש את Tx5 גם כן מכיוון שהוא עשוי להתנהג אחרת בהתחשב בביצוע החדש של Tx4. עם זאת, במקום רק לבצע מחדש את כל העסקאות לאחר ה-Tx4 שבטל כעת, אנו יכולים לעבור את גרף התלות שנבנה מהטרנזקציות שביצוען כבר הסתיים ולבצע מחדש רק עסקאות שהיו תלויות ב-Tx4.

### מימוש חדש של Rust עבור Cairo-VM

חוזים חכמים ב-StarkNet נכתבים בקהיר ומבוצעים בתוך ה-Cairo-VM, שהמפרט מופיע בעיתון[Cairo](https://eprint.iacr.org/2021/1063.pdf). נכון לעכשיו, הרצף משתמש ביישום[python](https://github.com/starkware-libs/cairo-lang/tree/master/src/starkware/cairo/lang/vm)של Cairo-VM. כדי לייעל את ביצועי הטמעת ה-VM, התחלנו במאמץ לכתוב מחדש את ה-VM בחלודה. הודות לעבודה הנהדרת של[Lambdaclass](https://lambdaclass.com/), שהם עד עכשיו צוות שלא יסולא בפז במערכת האקולוגית של StarkNet, המאמץ הזה מתממש בקרוב.

יישום החלודה של ה-VM,[cairo-rs](https://github.com/lambdaclass/cairo-rs), יכול כעת להפעיל קוד מקורי של קהיר. השלב הבא הוא טיפול בביצוע חוזים חכמים ואינטגרציות עם הסיקוונסר הפיתוני. לאחר השילוב עם cairo-rs, ביצועי הסיקוונסר צפויים להשתפר משמעותית.

### יישום מחדש של רצף ב-Rust

המעבר שלנו מפיתון לחלודה לשיפור הביצועים אינו מוגבל ל-Cairo VM. לצד השיפורים שהוזכרו לעיל, אנו מתכננים לשכתב את הרצף מאפס בחלודה. בנוסף ליתרונות הפנימיים של Rust, זה מציג הזדמנות לאופטימיזציות אחרות לסיקוונסר. ברשימה של זוג, נוכל ליהנות מהיתרונות של קהיר ללא תקורה של תקשורת פיתון-חלודה, ונוכל לעצב מחדש לחלוטין את האופן שבו המדינה מאוחסנת והגישה אליה (שהיום מבוססת על מבנה[Patricia-Trie](https://docs.starknet.io/documentation/develop/State/starknet-state/#state_commitment)).

### מה עם מוכיחים?

לאורך הפוסט הזה, לא הזכרנו את האלמנט אולי המפורסם ביותר של אוסף תוקף - המוכיח. אפשר לדמיין כי בהיותו הרכיב המתוחכם ביותר של הארכיטקטורה, זה צריך להיות צוואר הבקבוק, ובכך, מוקד האופטימיזציה. מעניין לציין שהרכיבים היותר "סטנדרטיים" הם כעת צוואר הבקבוק של StarkNet. היום, במיוחד עם[הוכחות רקורסיביות](https://medium.com/starkware/recursive-starks-78f8dd401025), אנחנו יכולים להכניס הרבה יותר עסקאות מהתנועה הנוכחית ב-Testnet/Mainnet להוכחה. למעשה, כיום, בלוקים של StarkNet מוכחים לצד עסקאות StarkEx, כאשר האחרונות עלולות לצבור לפעמים כמה מאות אלפי מטבעות NFT.

### סיכום

מקבילות, חלודה ועוד - תתכוננו ל-TPS משופר בגרסאות StarkNet הקרובות.